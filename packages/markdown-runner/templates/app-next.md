---
packageName: ""
packagePrefix: "@monorepo-starter"
---

### Create a new package

```bash
mkdir -p apps/$packageName
```

### Run `pnpm create next-app` & update `package.json`

```bash
pnpm create next-app@latest apps/$packageName --ts --tailwind --import-alias "~/*" --eslint --app --src-dir --turbopack --empty --use-pnpm --skip-install
# cd
cd apps/$packageName
# add scripts
pnpm pkg set scripts.check-types="tsc --noEmit"
# install
pnpm install
# add production dependencies
pnpm pkg set dependencies.next="catalog:"
pnpm pkg set dependencies.react="catalog:"
pnpm pkg set dependencies.react-dom="catalog:"
# add devDependencies
pnpm pkg set devDependencies.@eslint/eslintrc="catalog:"
pnpm pkg set devDependencies.@tailwindcss/postcss="catalog:"
pnpm pkg set devDependencies.@types/node="catalog:"
pnpm pkg set devDependencies.@types/react="catalog:"
pnpm pkg set devDependencies.@types/react-dom="catalog:"
pnpm pkg set devDependencies.eslint="catalog:"
pnpm pkg set devDependencies.eslint-config-next="catalog:"
pnpm pkg set devDependencies.tailwindcss="catalog:"
pnpm pkg set devDependencies.typescript="catalog:"
```

### Add workspace setup

```bash
# add production workspace dependencies
pnpm add --workspace $packagePrefix/ui $packagePrefix/utils
# add devDependencies workspace dependencies
pnpm add -D --workspace $packagePrefix/eslint-config $packagePrefix/typescript-config
```

Update `next.config.ts`

```diff filename="next.config.ts"
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
+ transpilePackages: ['$packagePrefix/utils', '$packagePrefix/ui'],
};

export default nextConfig;
```

Update `src/app/layout.tsx`

```diff filename="src/app/layout.tsx"
import type { Metadata } from 'next';
import './globals.css';

+import '$packagePrefix/ui/globals.css';

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
```

Update `tsconfig.json`

```diff filename="tsconfig.json"
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "~/*": ["./src/*"],
+     "@monorepo-starter/ui/*": ["../../packages/ui/src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

### Add test environment (`vitest`, `playwright`)

```bash
pnpm add -D @playwright/test @testing-library/dom @testing-library/react @vitejs/plugin-react jsdom vite-tsconfig-paths vitest
pnpm pkg set scripts.test="vitest"
pnpm pkg set scripts.test:e2e="playwright test"
```

Add `vitest.config.ts`

```ts filename="vitest.config.mts"
import react from '@vitejs/plugin-react';
import tsconfigPaths from 'vite-tsconfig-paths';
import { defineConfig } from 'vitest/config';

export default defineConfig({
  plugins: [tsconfigPaths(), react()],
  test: {
    environment: 'jsdom',
    exclude: ['e2e/**', 'node_modules/**'],
  },
});
```

Add `playwright.config.ts`

```ts filename="playwright.config.ts"
import { defineConfig, devices } from '@playwright/test';

/**
 * Read environment variables from file.
 * https://github.com/motdotla/dotenv
 */
// import dotenv from 'dotenv';
// import path from 'path';
// dotenv.config({ path: path.resolve(__dirname, '.env') });

/**
 * See https://playwright.dev/docs/test-configuration.
 */
export default defineConfig({
  testDir: './e2e',
  /* Run tests in files in parallel */
  fullyParallel: true,
  /* Fail the build on CI if you accidentally left test.only in the source code. */
  forbidOnly: !!process.env.CI,
  /* Retry on CI only */
  retries: process.env.CI ? 2 : 0,
  /* Opt out of parallel tests on CI. */
  workers: process.env.CI ? 1 : undefined,
  /* Reporter to use. See https://playwright.dev/docs/test-reporters */
  reporter: 'list',
  /* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */
  use: {
    /* Base URL to use in actions like `await page.goto('/')`. */
    baseURL: 'http://localhost:3000',

    /* Collect trace when retrying the failed test. See https://playwright.dev/docs/trace-viewer */
    trace: 'on-first-retry',
  },

  /* Configure projects for major browsers */
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },

    // {
    //   name: 'firefox',
    //   use: { ...devices['Desktop Firefox'] },
    // },

    // {
    //   name: 'webkit',
    //   use: { ...devices['Desktop Safari'] },
    // },

    /* Test against mobile viewports. */
    // {
    //   name: 'Mobile Chrome',
    //   use: { ...devices['Pixel 5'] },
    // },
    // {
    //   name: 'Mobile Safari',
    //   use: { ...devices['iPhone 12'] },
    // },

    /* Test against branded browsers. */
    // {
    //   name: 'Microsoft Edge',
    //   use: { ...devices['Desktop Edge'], channel: 'msedge' },
    // },
    // {
    //   name: 'Google Chrome',
    //   use: { ...devices['Desktop Chrome'], channel: 'chrome' },
    // },
  ],

  /* Run your local dev server before starting the tests */
  webServer: {
    command: 'pnpm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

Append `.gitignore`

```txt filename=".gitignore" append
# Playwright
/test-results/
/playwright-report/
/blob-report/
/playwright/.cache/
EOF
```

Add `__tests__/main.test.tsx`

```tsx filename="__tests__/main.test.tsx"
import { render } from '@testing-library/react';
import { expect, test } from 'vitest';
import Page from '~/app/page';

test('메인 페이지 로딩', () => {
  render(<Page />);
  expect(document.body).not.toBeNull();
});
```

Add `e2e/main.spec.ts`

```ts filename="e2e/main.spec.ts"
import { test } from '@playwright/test';

test('메인 페이지 로딩', async ({ page }) => {
  await page.goto('/');
  await page.waitForLoadState('load');
});
```

### Add docker setup

```dockerfile filename="Dockerfile"
# ------------------------------------------------------------------------------
# Step 0: 기본 이미지 설정 및 환경 변수 설정
# ------------------------------------------------------------------------------
FROM node:22-alpine AS base

# 전역 환경변수
ENV WORKDIR=/app
ENV APP_NAME=$packageName
ENV PORT=3000
ENV STANDALONE=true

# pnpm 환경 변수 설정(없으면 pnpm 설치 시 오류 발생)
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV PNPM_VERSION=10.11.1

# ------------------------------------------------------------------------------
# Step 1: 소스 코드 준비 및 정리
# ------------------------------------------------------------------------------
FROM base AS builder

# node.js 실행을 위한 apk 라이브러리 설치
RUN apk add --no-cache libc6-compat

# 작업 디렉토리: /app
WORKDIR $WORKDIR

# pnpm, turbo 전역 설치
RUN corepack enable && corepack prepare pnpm@$PNPM_VERSION --activate
RUN pnpm add -g turbo

# 소스 코드 복사(.dockerignore 에 있는 파일은 제외)
# 로컬 루트부터 전체 코드를 컨테이너 /app 디렉토리로 복사
COPY . .

# turbo prune 실행
RUN turbo prune $APP_NAME --docker

# ------------------------------------------------------------------------------
# Step 2: 의존성 설치 및 프로젝트 빌드
# 이 단계에서 실행 가능한 .next/ 폴더가 생성
# ------------------------------------------------------------------------------
FROM base AS installer

# node.js 실행을 위한 apk 라이브러리 설치
RUN apk add --no-cache libc6-compat

# 작업 디렉토리: /app
WORKDIR $WORKDIR

# pnpm, turbo 전역 설치
RUN corepack enable && corepack prepare pnpm@$PNPM_VERSION --activate
RUN pnpm add -g turbo

# 의존성 설치를 위한 build 단계로부터 파일 복사
COPY .gitignore .gitignore
COPY --from=builder /app/out/json/ .
COPY --from=builder /app/out/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /app/out/pnpm-workspace.yaml ./pnpm-workspace.yaml

# pnpm install
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile

# better-sqlite3 Alpine 환경에 맞게 다시 빌드
RUN pnpm rebuild better-sqlite3

# 빌드에 필요한 모든 소스 파일 복사
COPY --from=builder /app/out/full/ .

# 로컬 루트의 turbo.json 을 작업디렉토리에 복사
COPY turbo.json turbo.json

# SQLite 기능 사용시, sqlite3 데이터베이스 디렉토리 생성
RUN mkdir -p ./apps/$APP_NAME/database

# 프로젝트와 그 의존성 프로젝트들을 빌드
RUN pnpm turbo build --filter=$APP_NAME...

# ------------------------------------------------------------------------------
# Step 3: 프로덕션 실행 환경 설정
# ------------------------------------------------------------------------------
FROM base AS runner
WORKDIR $WORKDIR

# 보안 강화: 루트 권한이 아닌 별도의 시스템 사용자로 실행
# 1001:1001의 UID:GID로 nextjs 사용자와 그룹 생성
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# user 변경
USER nextjs

# 최종 빌드된 파일에서 필수 파일만 추출
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/next.config.ts .
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/package.json .
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/.next/standalone ./
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/.next/static ./apps/$APP_NAME/.next/static
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/public ./apps/$APP_NAME/public
# Log 기능 사용시,
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/logs ./apps/$APP_NAME/logs
# SQLite 기능 사용시,
COPY --from=installer --chown=nextjs:nodejs /app/apps/$APP_NAME/database ./apps/$APP_NAME/database

# Next.js 애플리케이션 서버 실행
# standalone 모드로 생성된 server.js를 실행
CMD node apps/$APP_NAME/server.js
```